%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

% Author: Romain "Artefact2" Dal Maso <artefact2@gmail.com>
% 
% This program is free software. It comes without any warranty, to the
% extent permitted by applicable law. You can redistribute it and/or
% modify it under the terms of the Do What The Fuck You Want To Public
% License, Version 2, as published by Sam Hocevar. See
% http://sam.zoy.org/wtfpl/COPYING for more details.

% Parts
\renewcommand*{\beforepartskip}{}
\renewcommand*{\afterpartskip}{\vfil}

% Chapters
\newcommand*{\phChapterHeader}{%
  \begin{textblock*}{.5\paperwidth}(0pt,0pt)
    \includegraphics[width=.5\paperwidth]{assets/header-chapter}
  \end{textblock*}%
  \begin{textblock*}{.5\paperwidth}(.5\paperwidth,0pt)
    \reflectbox{\includegraphics[width=.5\paperwidth]{assets/header-chapter}}
  \end{textblock*}%
}
\renewcommand*{\chaptitlefont}{\color{chapter}\HUGE\mreaves}
\renewcommand*{\printchaptername}{}
\renewcommand*{\chapternamenum}{}
\renewcommand*{\chapnumfont}{\chaptitlefont}
\makeatletter
\renewcommand*{\printchapternum}{\phChapterHeader\chapnumfont \@chapapp\space\thechapter:\space}
\makeatother
\renewcommand*{\afterchapternum}{}
\renewcommand*{\printchapternonum}{\phChapterHeader}
\setlength{\beforechapskip}{0pt}
\setlength{\afterchapskip}{10pt}

\newcommand*{\phRootChapter}[1]{%
  \chapter*{#1}
  \addcontentsline{toc}{part}{#1}
  \markboth{#1}{#1}
}

\newcommand*{\phAppendix}{\appendix\settocdepth{part}}

\newcommand*{\phRootAppendix}[1]{%
  \chapter{#1}
  \addcontentsline{toc}{part}{Appendix\space\thechapter:\space#1}
  \markboth{#1}{#1}
}

% Sections
\setsecnumformat{}
\setsecheadstyle{\color{chapter}\HUGE\mreaves}
\setaftersecskip{1pt}

% Subsections
\newcommand{\ruledsubsec}[1]{
  \color{chapter}\Huge\mreaves\begin{minipage}{\columnwidth} #1 \color{subsecrule} \rule[22pt]{\columnwidth}{1pt} \end{minipage} \vspace*{-30pt}
}
\setsubsecheadstyle{\ruledsubsec}

% Subsubsections
\setsubsubsecheadstyle{\color{chapter}\LARGE\mreaves}
\setaftersubsubsecskip{1pt}

% Table of Contents
\twocoltocetc
\renewcommand*{\cftsectiondotsep}{0.5}

\renewcommand*{\cftpartfont}{\color{chapter}\LARGE\mreaves}
\renewcommand*{\cftpartname}{Part\space}
\renewcommand*{\cftpartaftersnum}{:\space}

\renewcommand*{\cftpartnumwidth}{25pt}
\renewcommand*{\cftchapterfont}{\color{chapter}\Large\mreaves}
\renewcommand*{\cftchaptername}{Chapter\space}
\renewcommand*{\cftappendixname}{Appendix\space}
\renewcommand*{\cftchapteraftersnum}{:\space}
\renewcommand*{\cftchapterindent}{10pt}
\renewcommand*{\cftpartafterpnum}{\\\hspace*{-57pt}\color{subsecrule}\rule[8pt]{\columnwidth}{1pt}\vspace*{-18pt}} % XXX: -57pt ?!
\renewcommand*{\cftbeforepartskip}{15pt}

\renewcommand*{\cftsectionnumwidth}{1pt}
\renewcommand*{\cftsectionpresnum}{\fontsize{.001pt}{.001pt}\selectfont} % XXX: this is probably the worst hack I've ever done
\renewcommand*{\cftsectionindent}{20pt}

% Cover page
\newcommand*{\hbCoverFile}{assets/cover}
\newcommand*{\hbSubcoverFile}{assets/cover2}
\newcommand{\hbTitle}{Title. Renew me!}
\newcommand{\hbSubtitle}{Subtitle. Renew me!}

\newcommand{\hbMakecover}{
  % XXX: what is causing this 6pt of whitespace?
  \SetBgContents{\hspace{-6pt}\begin{overpic}[width=\paperwidth,height=\paperheight]{assets/background}\put(0,0){\includegraphics[width=\paperwidth,height=\paperheight]{\hbCoverFile}}\end{overpic}}
  \onecolumn
  \thispagestyle{empty}
  \begin{textblock*}{3cm}(.5\paperwidth-1.5cm,1cm)
    \includegraphics[width=3cm]{assets/dnd-logo-initials}
  \end{textblock*}
  
  \begin{textblock*}{\paperwidth-4cm}(2cm,\paperheight-4cm)
    \begin{center}
      \LARGE
      % XXX: font doesn't look right
      \fillstroke{[1 1 1]}{[0]}{[0]}{.5}{\textbf{\hbSubtitle}}
    \end{center}
  \end{textblock*}
  
  \vspace*{15mm}
  
  \begin{center}
    \nodesto
    \fontsize{48pt}{48pt}\selectfont
    \fillstroke{[1 1 1]}{[0]}{[0]}{1.5}{\MakeUppercase\hbTitle}
    
    \vspace*{-30pt}\includegraphics[width=.5\paperwidth]{assets/separator}
  \end{center}
  \clearpage
  \twocolumn
  \SetBgContents{\hbBackgroundContents}
}

\newcommand{\hbMakesubcover}{
  \SetBgContents{\hspace{-6pt}\begin{overpic}[width=\paperwidth,height=\paperheight]{assets/background}\put(0,0){\includegraphics[width=\paperwidth,height=\paperheight]{\hbSubcoverFile}}\end{overpic}}
  \onecolumn
  \thispagestyle{empty}
  \begin{textblock*}{1.5cm}(.5\paperwidth-.75cm,\paperheight-3cm)
    \includegraphics[width=1.5cm]{assets/dnd-logo-amp}
  \end{textblock*}
  
  \vspace*{15mm}
  
  \begin{center}
    \nodesto
    \fontsize{48pt}{48pt}\selectfont
    \MakeUppercase
    \hbTitle
    
    \vspace*{-30pt}\includegraphics[width=.5\paperwidth]{assets/separator}
  \end{center}
  \clearpage
  \twocolumn
  \SetBgContents{\hbBackgroundContents}
}
