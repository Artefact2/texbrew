%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

% Author: Romain "Artefact2" Dal Maso <artefact2@gmail.com>
% 
% This program is free software. It comes without any warranty, to the
% extent permitted by applicable law. You can redistribute it and/or
% modify it under the terms of the Do What The Fuck You Want To Public
% License, Version 2, as published by Sam Hocevar. See
% http://sam.zoy.org/wtfpl/COPYING for more details.

\newlength{\phCurparskip}
\newlength{\phCurparindent}

\newcommand*{\phNotePrevSubsubsectionStyle}{}
\newcommand*{\phNotePrevParagraphStyle}{}

\NewEnviron{phNote}{
  \setlength{\phCurparskip}{\parskip}
  \setlength{\phCurparindent}{\parindent}
  \renewcommand*{\phNotePrevSubsubsectionStyle}{\subsubsecheadstyle}
  \renewcommand*{\phNotePrevParagraphStyle}{\paraheadstyle}
  \setsubsubsecheadstyle{\vspace*{-12pt}\scaly\large\bfseries\scshape}
  \setparaheadstyle{\scaly\bfseries}
  % XXX: why -1.4pt?
  \noindent\scalebox{1}[-1]{\includegraphics[width=\columnwidth,height=6pt]{assets/note}}\vspace*{-1.4pt}\nopagebreak\\%
  \noindent\colorbox{note}{\hspace{2pt}\begin{minipage}{\columnwidth-4pt-2\fboxsep}\setlength{\parskip}{\phCurparskip}\setlength{\parindent}{\phCurparindent}\noindent\scaly\small\BODY\end{minipage}\hspace{2pt}}\vspace*{-1.4pt}\nopagebreak\\%
  \noindent\includegraphics[width=\columnwidth,height=6pt]{assets/note}\vspace*{4pt}
  \setsubsubsecheadstyle{\phNotePrevSubsubsectionStyle}
  \setparaheadstyle{\phNotePrevParagraphStyle}
}
